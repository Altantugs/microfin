{% extends 'base.html.twig' %}

{% block title %}Тайлан{% endblock %}

{% block body %}
  <h1>Нийт тайлан</h1>

  {% for label, messages in app.flashes %}
    {% for m in messages %}
      <div style="padding:8px;margin:6px 0;border:1px solid #ddd">{{ m }}</div>
    {% endfor %}
  {% endfor %}

  <form method="get" action="{{ path('report_summary') }}"
        style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:12px 0;border:1px solid #eee;padding:12px">
    <div>
      <label>Эхлэх огноо</label><br>
      <input type="date" name="from" value="{{ filters.from|default('') }}">
    </div>
    <div>
      <label>Дуусах огноо</label><br>
      <input type="date" name="to" value="{{ filters.to|default('') }}">
    </div>
    <div>
      <label>Төрөл</label><br>
      <select name="type">
        <option value="">— Бүгд —</option>
        {% for t in types|default([]) %}
          <option value="{{ t }}" {{ filters.type is defined and filters.type == t ? 'selected' : '' }}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Чиглэл</label><br>
      <select name="dir">
        <option value="">— Бүгд —</option>
        <option value="in"  {{ filters.dir|default('') == 'in'  ? 'selected' : '' }}>Орлого</option>
        <option value="out" {{ filters.dir|default('') == 'out' ? 'selected' : '' }}>Зарлага</option>
      </select>
    </div>
    <div>
      <label>Маягтын төрөл</label><br>
      <select name="origin">
        <option value="">— Бүгд —</option>
        <option value="CASH" {{ (filters.origin|default('')) == 'CASH' ? 'selected' : '' }}>КАСС</option>
        <option value="BANK" {{ (filters.origin|default('')) == 'BANK' ? 'selected' : '' }}>ХАРИЛЦАХ</option>
      </select>
    </div>

    <div style="min-width:220px;">
      <label>Хайлт (утга)</label><br>
      <input type="text" name="q" value="{{ filters.q|default('') }}" placeholder="ж: кофе, оффис, түлш..." />
    </div>

    {# --- ШИНЭ: Харилцагч (distinct жагсаалтаас) --- #}
    <div>
      <label>Харилцагч</label><br>
      <select name="customer">
        <option value="">— Бүгд —</option>
        {% for c in customers|default([]) %}
          <option value="{{ c }}" {{ (filters.customer|default('')) == c ? 'selected' : '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Эхлэх үлдэгдэл</label><br>
      <input type="number" step="0.01" name="opening" value="{{ openingBalance|default(0) }}">
    </div>

    <div>
      <label>Нэг хуудсанд</label><br>
      <select name="perPage">
        {% for n in pagination.allowed|default([30,40,50,100,200]) %}
          <option value="{{ n }}" {{ pagination.perPage|default(30) == n ? 'selected' : '' }}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <button type="submit">Шүүх</button>
      <a href="{{ path('report_summary') }}" style="margin-left:8px">Цэвэрлэх</a>
    </div>
  </form>

  <div style="display:flex;gap:24px;margin:16px 0;flex-wrap:wrap;">
    <div><b>Эхлэх үлдэгдэл:</b> {{ (openingBalance|default(0))|number_format(2, '.', ',') }}</div>
    <div><b>Орлого (нийт):</b> {{ (income|default(0))|number_format(2, '.', ',') }}</div>
    <div><b>Зарлага (нийт):</b> {{ (expense|default(0))|number_format(2, '.', ',') }}</div>
    <div><b>Үлдэгдэл (нийт):</b> {{ (balance|default(0))|number_format(2, '.', ',') }}</div>
    <div style="color:#666"><b>Мөр (нийт):</b> {{ totalCount|default(0) }}</div>
  </div>

  <div style="margin:12px 0;border:1px solid #eee;padding:12px;">
    <h3 style="margin:0 0 8px 0;">КАСС / ХАРИЛЦАХ нийлбэр</h3>
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;max-width:700px;">
      <thead>
        <tr>
          <th>Эх сурвалж</th>
          <th style="text-align:right;">Орлого</th>
          <th style="text-align:right;">Зарлага</th>
          <th style="text-align:right;">Үлдэгдэл</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="background:#f5f5f5;border:1px solid #ddd;border-radius:12px;padding:2px 8px;">КАСС</span></td>
          <td style="text-align:right;">{{ (byOrigin.cash.income|default(0))|number_format(2, '.', ',') }}</td>
          <td style="text-align:right;">{{ (byOrigin.cash.expense|default(0))|number_format(2, '.', ',') }}</td>
          <td style="text-align:right;">{{ (byOrigin.cash.balance|default(0))|number_format(2, '.', ',') }}</td>
        </tr>
        <tr>
          <td><span style="background:#eef7ff;border:1px solid #cfe4ff;border-radius:12px;padding:2px 8px;">ХАРИЛЦАХ</span></td>
          <td style="text-align:right;">{{ (byOrigin.bank.income|default(0))|number_format(2, '.', ',') }}</td>
          <td style="text-align:right;">{{ (byOrigin.bank.expense|default(0))|number_format(2, '.', ',') }}</td>
          <td style="text-align:right;">{{ (byOrigin.bank.balance|default(0))|number_format(2, '.', ',') }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 style="margin-top:16px;">Гүйлгээний жагсаалт</h3>
  <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
    <thead>
      <tr>
        <th>Огноо</th>
        <th>Гүйлгээний утга</th>
        <th style="text-align:right">Дүн</th>
        <th style="text-align:right">Орлого</th>
        <th style="text-align:right">Зарлага</th>
        <th style="text-align:right">Үлдэгдэл</th>
        <th>Эх сурвалж</th>
        <th>Харилцагч</th>
        <th>Төрөл</th>
      </tr>
    </thead>
    <tbody>
      {% set running = startBalance|default(0) %}
      {% if rows is defined and rows is not empty %}
        {% for t in rows %}
          {% set amt = t.amount + 0 %}
          {% set running = running + amt %}
          <tr>
            <td>{{ t.date ? t.date|date('Y-m-d') : '' }}</td>
            <td>{{ t.description }}</td>
            <td style="text-align:right">{{ amt|number_format(2, '.', ',') }}</td>
            <td style="text-align:right">
              {{ (t.isIncome ?? (t.getIsIncome is defined and t.getIsIncome ? t.getIsIncome : false)) ? amt|number_format(2, '.', ',') : '' }}
            </td>
            <td style="text-align:right">
              {{ (t.isIncome ?? (t.getIsIncome is defined and t.getIsIncome ? t.getIsIncome : false)) ? '' : (amt * -1)|number_format(2, '.', ',') }}
            </td>
            <td style="text-align:right">{{ running|number_format(2, '.', ',') }}</td>
            <td>
              {% if t.origin == 'CASH' %}
                <span style="background:#f5f5f5;border:1px solid #ddd;border-radius:12px;padding:2px 8px;white-space:nowrap;">КАСС</span>
              {% elseif t.origin == 'BANK' %}
                <span style="background:#eef7ff;border:1px solid #cfe4ff;border-radius:12px;padding:2px 8px;white-space:nowrap;">ХАРИЛЦАХ</span>
              {% else %}
                <span style="color:#999">-</span>
              {% endif %}
            </td>
            <td>{{ t.customer ?: '-' }}</td>
            <td>{{ t.category ?: '-' }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="9">Мэдээлэл алга.</td></tr>
      {% endif %}
    </tbody>
  </table>

  {% if pagination is defined and pagination.totalPages > 1 %}
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;">
      {% set current = pagination.page %}
      {% set total   = pagination.totalPages %}
      {% set per     = pagination.perPage %}
      {% set baseUrl = path('report_summary', {
        from: filters.from|default(''),
        to: filters.to|default(''),
        type: filters.type|default(''),
        dir:  filters.dir|default(''),
        origin: filters.origin|default(''),
        q: filters.q|default(''),
        customer: filters.customer|default(''),
        perPage: per
      }) %}

      {% if current > 1 %}
        <a href="{{ baseUrl ~ '&page=' ~ (current - 1) }}">« Өмнөх</a>
      {% endif %}

      {% for p in 1..total %}
        {% if p == current %}
          <span style="padding:4px 8px;border:1px solid #aaa;border-radius:6px;background:#eee;">{{ p }}</span>
        {% elseif p <= 2 or p > total-2 or (p >= current-2 and p <= current+2) %}
          <a href="{{ baseUrl ~ '&page=' ~ p }}" style="padding:4px 8px;">{{ p }}</a>
        {% elseif p == 3 and current > 5 %}
          <span>…</span>
        {% elseif p == total-2 and current < total-4 %}
          <span>…</span>
        {% endif %}
      {% endfor %}

      {% if current < total %}
        <a href="{{ baseUrl ~ '&page=' ~ (current + 1) }}">Дараах »</a>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
